<?php

namespace App\Admin;


use App\Entity\Profile;
use App\Entity\Transaction;
use Sonata\AdminBundle\Form\FormMapper;
use Sonata\AdminBundle\Show\ShowMapper;
use Sonata\AdminBundle\Admin\AbstractAdmin;
use Sonata\AdminBundle\Datagrid\ListMapper;
use Sonata\AdminBundle\Form\Type\ModelType;
use Symfony\Bridge\Twig\Mime\TemplatedEmail;
use Sonata\AdminBundle\Datagrid\DatagridMapper;
use Sonata\AdminBundle\Datagrid\ProxyQueryInterface;
use Symfony\Component\Form\Extension\Core\Type\TextType;
use Symfony\Component\Form\Extension\Core\Type\EmailType;
use Symfony\Component\Mailer\MailerInterface;
use Symfony\Component\PasswordHasher\Hasher\UserPasswordHasherInterface;

class UserAdmin extends AbstractAdmin
{
    private $passwordHasher;
    private MailerInterface $mailer;

    public function __construct(string $code, string $class, string $baseControllerName, UserPasswordHasherInterface $passwordHasher, MailerInterface $mailer)
    {
        parent::__construct($code, $class, $baseControllerName);

        $this->passwordHasher = $passwordHasher;
        $this->mailer = $mailer;
    }

    public function configureFormFields(FormMapper $form): void
    {
        parent::configureFormFields($form);

        $form
            ->tab('Client')
                ->with('Info Client')
                    ->add('username', TextType::class, [
                        'attr' => [
                            'placeholder' => 'Swift'
                        ],
                        'label' => 'Swift'
                    ])
                    ->add('email', EmailType::class, [
                        'attr' => [
                            'placeholder' => 'Email'
                        ],
                        'label' => 'Email'
                    ])
                ->end()
            ->end()
            ->tab('Profile')
                ->with('Profile Client')
                    ->add('profile', ModelType::class, [
                        'class' => Profile::class,
                        'property' => 'fullname'
                    ])
                ->end()
            ->end()
            ->tab('Statut')
                ->with('Statut Transaction')
                    ->add('transaction', ModelType::class, [
                        'class' => Transaction::class,
                        'property' => 'sender'
                    ])
                ->end()
            ->end()
        ;
    }

    public function configureDatagridFilters(DatagridMapper $filter): void
    {
        parent::configureDatagridFilters($filter); // TODO: Change the autogenerated stub

        $filter
            ->add('username', null, ['label' => 'Swift'])
            ->add('email')
            ->add('profile')
        ;

    }

    public function configureListFields(ListMapper $list): void
    {
        parent::configureListFields($list); // TODO: Change the autogenerated stub

        $list
            ->add('id')
            ->addIdentifier('username', null, ['label' => 'Swift'])
            ->add('email')
            ->add('profile')
            ->add('transaction')
        ;
    }

    public function configureShowFields(ShowMapper $show): void
    {
        parent::configureShowFields($show); // TODO: Change the autogenerated stub

        $show
            ->add('username', null, ['label' => 'Swift'])
            ->add('email')
        ;
    }

    public function prePersist(object $user): void
    {
        parent::prePersist($user); // TODO: Change the autogenerated stub

        $user->setPassword(
                $this->passwordHasher->hashPassword($user, 'bonjour1')
        );
        $user->setRoles(['ROLE_CUSTOMER', 'ROLE_USER']);
    }

    public function postPersist(object $user): void 
    {
        parent::postPersist($user);

        $email = (new TemplatedEmail())
            ->from('no-reply@eastwest-financial.com')
            ->to($user->getEmail())
            ->subject('Pending Bank Transaction') // to do
            ->htmlTemplate('emails/new_transaction.twig')
            ->context([
                'user' => $user
            ])
        ;
        
        $this->mailer->send($email);
    }

    protected function configureQuery(ProxyQueryInterface $query): ProxyQueryInterface
    {
        $query = parent::configureQuery($query);

        $role = 'ROLE_CUSTOMER';
        $query->andWhere($query->expr()->like('o.roles', ':param'))
            ->setParameter('param', "%$role%")
        ;
        return $query;
    }

}